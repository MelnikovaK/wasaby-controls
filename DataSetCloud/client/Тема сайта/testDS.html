<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
   <meta name="ws-access" content=""/>
   <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
   <title>C:/projects/sbis3-controls/DataSetCloud/client/Тема сайта/test.xaml</title>
   <link rel="stylesheet" href="/ws/css/core.css" type="text/css"/>
   <link rel="stylesheet" href="/ws/css/themes/wi_scheme.css" type="text/css"/>

   <link rel="stylesheet" type="text/css" href="/resources/Tema_sajta/fonts/index.css">
   <link rel="stylesheet" type="text/css" href="/resources/Tema_sajta/icons/index.css">

   <script type="text/javascript">
      // new config support
      window.wsConfig = {
         wsRoot: '/ws/',
         appRoot: '/',
         resourceRoot: '/resources/',
         defaultServiceUrl: '/service/sbis-rpc-service300.dll',
         theme: 'wi_scheme',
         userConfigSupport: false,
         globalConfigSupport: true,
         saveLastState: true
      };
      window.WSRootPath = '/ws/';
      window.ResourcePath = '/resources/';
      window.ServicesPath = '/service/sbis-rpc-service300.dll';
      window.WSTheme = 'wi_scheme';
   </script>

   <script type="text/javascript" src="//cdn.sbis.ru/requirejs/2.1.6/require-min.js"></script>
   <script type="text/javascript" data-pack-name="require" src="/ws/ext/requirejs/config.js"></script>

   <script type="text/javascript" src="//cdn.sbis.ru/jquery/1.6.4/jquery-full.js"></script>
   <script type="text/javascript" src="//cdn.sbis.ru/jquery-cookie/04-04-2014/jquery-cookie-full.js"></script>

   <script type="text/javascript" src="/resources/contents.js"></script>

   <script type="text/javascript" data-pack-name="ws" src="/ws/lib/core.js"></script>

   <script type="text/javascript" id="ws-include-components"></script>


   <script type="text/javascript">
      $ws.core.ready.addCallback(function () {
         require([ 'bootup' ], function () {
            $ws.core.bootup();
         });
      });
   </script>

   <style>

      table {
         width: 100%;
      }

      table td {
         padding: 25px;
         border: 1px solid #000000;
         vertical-align: top;
         width: 50%;
      }

      .listViewItem{
         position: relative;
         height: 44px;
      }

      .controls-ListView__item {
         overflow: hidden;
         position: relative;
      }
      .controls-ListView__itemActions {
         position: absolute;
         height: 16px;
         right: 0;
         top: 50%;
         margin-top: -8px;
         z-index: 10;
         display: none;
      }
      .controls-ListView__action {
         margin-right: 16px;
      }

      .taskIcon {
         float: left;
         margin-top: 10px;
         cursor: pointer;
      }

      .editing .controls-ListView__itemActions{
         display: none !important;
      }

      .editing .view{
         display: none;
      }

       .taskTxt {
         height: 44px;
         line-height: 44px;
         padding-left: 35px;
         font-size: 24px;

      }
      .taskComplete {
         color: #a9a9a9;
         text-decoration: line-through;
      }

      .newTask,.listViewItem .text{
         width: 100%;
         height: 100%;
         font-size: 24px;
         line-height: 44px;
         box-sizing: border-box;
      }

      .newTask{
         margin-top: 10px;
         height: 44px;
      }
      .Tabs {
         margin-bottom: 8px;
      }
      .tab {
         display: inline-block;
         height: 24px;
         line-height: 24px;
         padding: 0 8px;
         cursor: pointer;
         border-radius: 3px;
      }

      .tab.active {
         color : #ffffff;
         background: #0a6a1e;
      }

      .sort{
         width: 24px;
         cursor: pointer;
      }

   </style>

</head>
<body>

<table>
   <tr>
      <td>
         <p>ListView DataSourceBL</p>

         <div class="Tabs" data-list="ListViewDS1">
            <a data-value="all" class="tab active">All</a>
            <a data-value="active" class="tab">Active</a>
            <a data-value="complete" class="tab">Completed</a>
         </div>
         <div class="sort icon-24 icon-ArrowDown icon-done" data-list="ListViewDS1" data-dir="DESC"></div>
         <div id="ListViewDS1" class="testBlock listView"></div>
         <input data-list="ListViewDS1" class="newTask" type="text" placeholder="new task"/>

      </td>
      <td>
         <p>ListView DataSourceMemory</p>

         <div class="Tabs" data-list="ListViewDS2">
            <a data-value="all" class="tab active">All</a>
            <a data-value="active" class="tab">Active</a>
            <a data-value="complete" class="tab">Completed</a>
         </div>
         <div class="sort icon-24 icon-ArrowDown icon-done" data-list="ListViewDS2" data-dir="DESC"></div>
         <div id="ListViewDS2" class="testBlock listView"></div>
         <input data-list="ListViewDS2" class="newTask" type="text" placeholder="new task"/>
      </td>
   </tr>
</table>


<script type="text/javascript">
   $ws.core.withComponents('Source').addCallback(function () {
      $(document).ready(function () {
         require([
            'js!SBIS3.CONTROLS.ListViewDS',
            'js!SBIS3.CONTROLS.Record',
            'js!SBIS3.CONTROLS.DataSourceMemory',
            'js!SBIS3.CONTROLS.DataSourceBL'
         ], function (ListViewDS, Record, DataSourceMemory, DataSourceBL) {

            var ds1 = new DataSourceBL('Заметка');

            var itemTpl1 = '<div class="listViewItem" style="overflow: hidden; border-bottom: 1px solid">\
                  <div class="view">\
                     <div class="taskIcon icon-24 icon-Successful{{?it.get("Завершена")}} icon-done{{??}} icon-disabled{{?}}"></div>\
                     <div class="taskTxt{{?it.get("Завершена")}} taskComplete{{?}}">{{=it.get("Содержимое")}}</div>\
                  </div>\
                  <input type="text" class="text"/>\
               </div>';

            var itemsActions=[
               {
                  icon : 'sprite:icon-16 icon-Erase icon-error',
                  handler : function(id) {
                     var self = this;
                     this._dataSource.destroy(id).addCallback(function(){
                        self._drawItems();
                     });

                  }
               }
            ];

            var elemClickHandler = function(id, data, target){
               //потому что теряется фокус при клике на инпут
               this.getContainer().unbind('click');
               this.setActive = function(){};
               this.onBringToFront = function(){};

               var self = this;
               if ($(target).hasClass('taskIcon')) {
                  data.set('Завершена', !(data.get('Завершена')));
                  this._dataSource.update(data).addCallback(function(){
                     self._drawItems();
                  });
               }
               else if ($(target).hasClass('taskTxt')) {
                  var listViewItem = $(target).closest('.listViewItem');
                  $('.listViewItem', this.getContainer()).removeClass('editing');
                  listViewItem.addClass('editing');
                  var $view = listViewItem.find('.view');
                  var $text=listViewItem.find('.text');
                  $text.val(data.get('Содержимое')).unbind('keydown').keydown(function (e) {
                     if (e.which === 13) {
                        data.set('Содержимое', $(this).val());
                        self._dataSource.update(data).addCallback(function(){
                           self._drawItems();
                        });
                     }
                     if (e.which === 27) {
                        listViewItem.removeClass('editing');
                        $view.show();
                     }
                  }).focus();
               }
            }

            new ListViewDS({
               element: "ListViewDS1",
               dataSource: ds1,
               itemTemplate: itemTpl1,
               itemsActions : itemsActions,
               elemClickHandler : elemClickHandler

            });

            var ds2 = new DataSourceMemory({
               data: [
                  {'@Заметка': 1, 'Содержимое': 'Поиграть в бильярд', 'Завершена': false},
                  {'@Заметка': 2, 'Содержимое': 'Посидеть в планшете', 'Завершена': false},
                  {'@Заметка': 3, 'Содержимое': 'Купить булку', 'Завершена': true}
               ],
               keyField: '@Заметка'
            });

            new ListViewDS({
               element: "ListViewDS2",
               dataSource: ds2,
               itemTemplate: itemTpl1,
               itemsActions : itemsActions,
               elemClickHandler : elemClickHandler
            });
            $(".tab").click(function(){
               var tabs = $(this).closest(".Tabs");
               $(".tab", tabs).removeClass('active');
               $(this).addClass('active');
               var
                  value = $(this).attr('data-value'),
                  view = $ws.single.ControlStorage.get(tabs.attr('data-list')),
                  filter;

               switch (value) {
                  case 'active' : filter = [{'Завершена' : false}]; break;
                  case 'complete' : filter = [{'Завершена' : true}]; break;
                  default : filter = [];
               }
               view.query(filter);
            });

            $('.sort').click(function () {
               var self = $(this),
                     view = $ws.single.ControlStorage.get(self.attr('data-list')),
                     filter = {},
                     dir = self.attr('data-dir'),
                     newDir,
                     sorting = [];
               if (dir == 'ASC') {
                  newDir = 'DESC';
                  self.removeClass('icon-ArrowUp').addClass('icon-ArrowDown');
               } else {
                  newDir = 'ASC';
                  self.removeClass('icon-ArrowDown').addClass('icon-ArrowUp');

               }
               self.attr('data-dir', newDir);
               sorting = [
                  {'Завершена': newDir}
               ];
               view.query(filter, sorting);
            });

            $('.newTask').keydown(function (e) {
               var inp = $(this);
               if (e.which === 13) {
                  var view = $ws.single.ControlStorage.get($(this).attr('data-list'));
                  view._dataSource.create().addCallback(function (rec) {
                     rec.set('Содержимое', inp.val());
                     rec.set('Завершена', false);
                     view._dataSource.update(rec).addCallback(function () {
                        view._drawItems();
                        inp.val('');
                     });
                  });
               }
            })

         });
      })
   });
</script>
</body>
</html>