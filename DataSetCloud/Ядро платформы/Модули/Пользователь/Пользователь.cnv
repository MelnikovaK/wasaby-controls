<?xml version="1.0" encoding="WINDOWS-1251"?>
<converter_library version="1.01">

  <converter abstract="0" call_once="1" last_changed="Буравлев М.С." name="ПеренестиПользователейИзПабликаВСхему" responsible="Буравлев М.С.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
  client int := null;
  schem text := context-&gt;'schema';
BEGIN
  IF schem IS DISTINCT FROM 'public' AND schem IS NOT NULL THEN
     EXECUTE 'SELECT x''' || substring( schem from '........$') || '''::int' INTO client;
     IF client IS NOT NULL THEN
EXECUTE 'WITH T as (
   (
	WITH RECURSIVE T( "@Пользователь", "Ревизия", "Логин", "Заблокирован", "Раздел", "Раздел@", "НаследоватьПрава", "email", "Имя", "ВременныйЛогин", "$Черновик", "Порядок" ) AS (
		SELECT T2."@Пользователь", T1."Ревизия", T2."Логин", T2."Заблокирован", T2."Раздел", T2."Раздел@", T2."НаследоватьПрава", T2."email", T2."Имя", T2."ВременныйЛогин", T2."$Черновик", 0
			FROM "public"."Пользователь" T2
				LEFT JOIN "НеактуальныйПользователь" T1 ON T1."Пользователь" = T2."@Пользователь"
					WHERE T2."@Пользователь" = ' || client || '
		UNION
		SELECT T2."@Пользователь", T1."Ревизия", T2."Логин", T2."Заблокирован", T2."Раздел", T2."Раздел@", T2."НаследоватьПрава", T2."email", T2."Имя", T2."ВременныйЛогин", T2."$Черновик", T."Порядок" + 1
			FROM "public"."Пользователь" T2
				LEFT JOIN "НеактуальныйПользователь" T1 ON T1."Пользователь" = T2."@Пользователь"
					JOIN T ON ( T."@Пользователь" = T2."Раздел" )
	)
	SELECT T."@Пользователь", T."Ревизия", T."Логин", T."Заблокирован", T."Раздел", T."Раздел@", T."НаследоватьПрава", T."email", T."Имя", T."ВременныйЛогин", T."$Черновик", T."Порядок"
		FROM T
	)
	UNION
	(
	WITH RECURSIVE T( "@Пользователь", "Ревизия", "Логин", "Заблокирован", "Раздел", "Раздел@", "НаследоватьПрава", "email", "Имя", "ВременныйЛогин", "$Черновик", "Порядок" ) AS (
		SELECT T2."@Пользователь", T1."Ревизия", T2."Логин", T2."Заблокирован", T2."Раздел", T2."Раздел@", T2."НаследоватьПрава", T2."email", T2."Имя", T2."ВременныйЛогин", T2."$Черновик", 0
			FROM "public"."Пользователь" T2
				LEFT JOIN "НеактуальныйПользователь" T1 ON T1."Пользователь" = T2."@Пользователь"
					WHERE T2."@Пользователь" = ' || client || '
		UNION
		SELECT u."@Пользователь", null::integer as "Ревизия", u."Логин", u."Заблокирован", u."Раздел", u."Раздел@", u."НаследоватьПрава", u."email", u."Имя", u."ВременныйЛогин", u."$Черновик", T."Порядок" - 1
			FROM "public"."Пользователь" u
				JOIN T ON ( T."Раздел" = u."@Пользователь" )
	)
	SELECT T."@Пользователь", T."Ревизия", T."Логин", T."Заблокирован", T."Раздел", T."Раздел@", T."НаследоватьПрава", T."email", T."Имя", T."ВременныйЛогин", T."$Черновик", T."Порядок"
		FROM T
	)
	ORDER BY "Порядок"
)
INSERT INTO ' || schem || '."Пользователь"( "@Пользователь", "Логин", "Раздел", "Раздел@", "НаследоватьПрава", "Заблокирован", "email", "Имя", "ВременныйЛогин", "$Черновик" )
   select "@Пользователь", "Логин", "Раздел", "Раздел@", "НаследоватьПрава", "Заблокирован", "email", "Имя", "ВременныйЛогин", "$Черновик"
     from T;';
     END IF;
  END IF;
END</body>
    </callback>
  </converter>

</converter_library>
